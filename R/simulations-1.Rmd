---
title: "Modelling vaccine queues and site capacity"
author: "Mark Hanly"
date: "11/02/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)

# For reproducibility
set.seed(193500)

# Load the package
library(queuecomputer)
library(dplyr)
library(lubridate)
library(ggplot2)
library(visNetwork)
library(tidyr)
library(RColorBrewer)
library(kableExtra)

# Peak and off-peak rates
loRate1 <- 1/30 # 1 patient every 30 minutes
hiRate1 <- 1/15 # 1 patient every 15 minutes

loRate2 <- 1/20 # 1 patient every 20 minutes
hiRate2 <- 1/5 # 1 patient every 5 minute

loRate3 <- 1/5 # 1 patient every 5 minutes
hiRate3 <- 1/2 # 1 patients every 2 minutes

# Number of customers

## Slow
n1_1 <- 180*loRate1
n1_2 <- 60*hiRate1   # Lunch time rush hour 
n1_3 <- 240*loRate1
n1_4 <- 60*hiRate1   # After work rush hour
n1_5 <- 60*loRate1
n1 <- n1_1 + n1_2 + n1_3 + n1_4 + n1_5

## Moderate
n2_1 <- 180*loRate2
n2_2 <- 60*hiRate2   # Lunch time rush hour 
n2_3 <- 240*loRate2
n2_4 <- 60*hiRate2   # After work rush hour
n2_5 <- 60*loRate2
n2 <- n2_1 + n2_2 + n2_3 + n2_4 + n2_5

## Fast
n3_1 <- 180*loRate3
n3_2 <- 60*hiRate3   # Lunch time rush hour 
n3_3 <- 240*loRate3
n3_4 <- 60*hiRate3   # After work rush hour
n3_5 <- 60*loRate3
n3 <- n3_1 + n3_2 + n3_3 + n3_4 + n3_5

# Emulate a lunchtime and after-work peak
rate1 <- c(rep(loRate1, n1_1), rep(hiRate1, n1_2), rep(loRate1, n1_3), rep(hiRate1, n1_4), rep(loRate1, n1_5)) 
arrivals1 <- cumsum(rexp(n1, rate = rate1))

rate2 <- c(rep(loRate2, n2_1), rep(hiRate2, n2_2), rep(loRate2, n2_3), rep(hiRate2, n2_4), rep(loRate2, n2_5)) 
arrivals2 <- cumsum(rexp(n2, rate = rate2))

rate3 <- c(rep(loRate3, n3_1), rep(hiRate3, n3_2), rep(loRate3, n3_3), rep(hiRate3, n3_4), rep(loRate3, n3_5)) 
arrivals3 <- cumsum(rexp(n3, rate = rate3))


arrivalsDF <- data.frame(
  speed = c(rep(1, length(arrivals1)), rep(2, length(arrivals2)), rep(3, length(arrivals3))), 
  time = c(arrivals1, arrivals2, arrivals3)*60 + parse_date_time("01-03-2021 09:00", "dmY HM")
  )

arrivalsDF$speed <- factor(arrivalsDF$speed, 
       levels = c('1', '2', '3'), 
        labels = c(paste0('Slow (', n1, ' patients)'),
                  paste0('Brisk (', n2, ' patients)'),
                  paste0('Heavy (', n3, ' patients)')
                  ))
         
# The time in each node of the queue

## Slow arrivals
regTime1 <- rexp(n1, 1/4) # Time in registration process
assTime1 <- rexp(n1, 1/7) # Time in assessment
vacTime1 <- rexp(n1, 1/2) # Time for vaccination
obsTime1 <- rnorm(n1, 15, 2) # Observation time

## Moderate arrivals
regTime2 <- rexp(n2, 1/4) # Time in registration process
assTime2 <- rexp(n2, 1/7) # Time in assessment
vacTime2 <- rexp(n2, 1/2) # Time for vaccination
obsTime2 <- rnorm(n2, 15, 2) # Observation time

## Fast arrivals
regTime3 <- rexp(n3, 1/4) # Time in registration process
assTime3 <- rexp(n3, 1/7) # Time in assessment
vacTime3 <- rexp(n3, 1/2) # Time for vaccination
obsTime3 <- rnorm(n3, 15, 2) # Observation time

# Modelling the nodes

## Scenario A (1 + 1 + 1)

### Scenario A - Slow
registrationA1 <- queue_step(arrivals = arrivals1, service = regTime1, servers = 1) 
assessmentA1 <- queue_step(arrivals = registrationA1$departures, service = assTime1, servers = 1)  
vaccinationA1 <- queue_step(arrivals = assessmentA1$departures, service = vacTime1, servers = 1)
observationA1 <- queue_step(arrivals = vaccinationA1$departures, service = obsTime1, servers = 1000) # places on limit on waiting room capacity; allows number in system to be calculated

### Scenario A - Moderate
registrationA2 <- queue_step(arrivals = arrivals2, service = regTime2, servers = 1) 
assessmentA2 <- queue_step(arrivals = registrationA2$departures, service = assTime2, servers = 1)  
vaccinationA2 <- queue_step(arrivals = assessmentA2$departures, service = vacTime2, servers = 1)  
observationA2 <- queue_step(arrivals = vaccinationA2$departures, service = obsTime2, servers = 1000)

### Scenario A - Fast
registrationA3 <- queue_step(arrivals = arrivals3, service = regTime3, servers = 1) 
assessmentA3 <- queue_step(arrivals = registrationA3$departures, service = assTime3, servers = 1)  
vaccinationA3 <- queue_step(arrivals = assessmentA3$departures, service = vacTime3, servers = 1)  
observationA3 <- queue_step(arrivals = vaccinationA3$departures, service = obsTime3, servers = 1000)


## Scenario B (2 + 2 + 2)

### Scenario B - Slow
registrationB1 <- queue_step(arrivals = arrivals1, service = regTime1, servers = 2) 
assessmentB1 <- queue_step(arrivals = registrationB1$departures, service = assTime1, servers = 2)  
vaccinationB1 <- queue_step(arrivals = assessmentB1$departures, service = vacTime1, servers = 2)  
observationB1 <- queue_step(arrivals = vaccinationB1$departures, service = obsTime1, servers = 1000)

### Scenario B - Moderate
registrationB2 <- queue_step(arrivals = arrivals2, service = regTime2, servers = 2) 
assessmentB2 <- queue_step(arrivals = registrationB2$departures, service = assTime2, servers = 2)  
vaccinationB2 <- queue_step(arrivals = assessmentB2$departures, service = vacTime2, servers = 2)  
observationB2 <- queue_step(arrivals = vaccinationB2$departures, service = obsTime2, servers = 1000)

### Scenario B - Fast
registrationB3 <- queue_step(arrivals = arrivals3, service = regTime3, servers = 2) 
assessmentB3 <- queue_step(arrivals = registrationB3$departures, service = assTime3, servers = 2)  
vaccinationB3 <- queue_step(arrivals = assessmentB3$departures, service = vacTime3, servers = 2)  
observationB3 <- queue_step(arrivals = vaccinationB3$departures, service = obsTime3, servers = 1000)


## Scenario C (4 + 2 + 2)

### Scenario C - Slow
registrationC1 <- queue_step(arrivals = arrivals1, service = regTime1, servers = 4) 
assessmentC1 <- queue_step(arrivals = registrationC1$departures, service = assTime1, servers = 6)  
vaccinationC1 <- queue_step(arrivals = assessmentC1$departures, service = vacTime1, servers = 6)  
observationC1 <- queue_step(arrivals = vaccinationC1$departures, service = obsTime1, servers = 1000)

### Scenario C - Moderate
registrationC2 <- queue_step(arrivals = arrivals2, service = regTime2, servers = 4) 
assessmentC2 <- queue_step(arrivals = registrationC2$departures, service = assTime2, servers = 6)  
vaccinationC2 <- queue_step(arrivals = assessmentC2$departures, service = vacTime2, servers = 6)  
observationC2 <- queue_step(arrivals = vaccinationC2$departures, service = obsTime2, servers = 1000)

### Scenario C - Fast
registrationC3 <- queue_step(arrivals = arrivals3, service = regTime3, servers = 4) 
assessmentC3 <- queue_step(arrivals = registrationC3$departures, service = assTime3, servers = 6)  
vaccinationC3 <- queue_step(arrivals = assessmentC3$departures, service = vacTime3, servers = 6)  
observationC3 <- queue_step(arrivals = vaccinationC3$departures, service = obsTime3, servers = 1000)


# Save summary data

## Scenario A
regSumA1 <- summary(registrationA1)
assSumA1 <- summary(assessmentA1)
vacSumA1 <- summary(vaccinationA1)
obsSumA1 <- summary(observationA1)
regSumA2 <- summary(registrationA2)
assSumA2 <- summary(assessmentA2)
vacSumA2 <- summary(vaccinationA2)
obsSumA2 <- summary(observationA2)
regSumA3 <- summary(registrationA3)
assSumA3 <- summary(assessmentA3)
vacSumA3 <- summary(vaccinationA3)
obsSumA3 <- summary(observationA3)

## Scenario B
regSumB1 <- summary(registrationB1)
assSumB1 <- summary(assessmentB1)
vacSumB1 <- summary(vaccinationB1)
obsSumB1 <- summary(observationB1)
regSumB2 <- summary(registrationB2)
assSumB2 <- summary(assessmentB2)
vacSumB2 <- summary(vaccinationB2)
obsSumB2 <- summary(observationB2)
regSumB3 <- summary(registrationB3)
assSumB3 <- summary(assessmentB3)
vacSumB3 <- summary(vaccinationB3)
obsSumB3 <- summary(observationB3)

## Scenario C
regSumC1 <- summary(registrationC1)
assSumC1 <- summary(assessmentC1)
vacSumC1 <- summary(vaccinationC1)
obsSumC1 <- summary(observationC1)
regSumC2 <- summary(registrationC2)
assSumC2 <- summary(assessmentC2)
vacSumC2 <- summary(vaccinationC2)
obsSumC2 <- summary(observationC2)
regSumC3 <- summary(registrationC3)
assSumC3 <- summary(assessmentC3)
vacSumC3 <- summary(vaccinationC3)
obsSumC3 <- summary(observationC3)

```


# Aim 
The aim of this analysis is to simulate vaccination capacity under different assumtions about (i) vaccination site capacity and (ii) frequency of patient arrivals.

# Scenarios

## Vaccination site capacity

We consider the following three vaccinations sites: 

1. A small general practice with 1 receptionist and 2 clinical staff (1 does assessment; 1 administers vaccine)
1. A large general practice with 2 receptionists and 4 clinical staff (2 do assessment; 2 administer vaccine)
1. A mass vaccination site with 4 receptionists and 12 clinical staff (6 do assessment; 6 administer vaccine)

## Frequency of patient arrivals 

Our modelling scenarios considers individuals arriving at the vaccination site between 9am and 8pm at three different speeds which we refer to as slow, brisk and heavy. For each level, the inter-arrival time at time $t$ is assumed to be exponentially distributed with a rate parameter of $\lambda_{t}$. To reflect busy periods, we define different levels of $\lambda_{t}$ during the lunch hour (12:00 to 13:00) and after work (17:00 to 18:00), as summarised below.


```{r}

ratesDF <- data.frame(
  level = c('Slow', 'Brisk', 'Heavy'),
  loRate = c(loRate1, loRate2, loRate3),
  loRate1 = c(paste('1 patient every', round(1/loRate1), 'minutes'), 
              paste('1 patient every', round(1/loRate2), 'minutes'), 
              paste('1 patient every', round(1/loRate3), 'minutes')), 
  hiRate = c(hiRate1, hiRate2, hiRate3),
  hiRate1 = c(paste('1 patient every', round(1/hiRate1), 'minutes'), 
            paste('1 patient every', round(1/hiRate2), 'minutes'), 
            paste('1 patient every', round(1/hiRate3), 'minutes')),
  n = c(n1, n2, n3)
)

kbl(ratesDF,
      format = 'html',
      digits = 3,
      booktabs = TRUE,
      linesep = '',
      label = 'agreements', 
      align = c('lrlrlr'),
      col.names = c("Frequency", "Off-peak rate", "Off-peak arrivals", "Peak rate", "Peak arrivals", "Total daily patients"),
      caption = "Assumptions for slow, brisk and heavy arrivals") %>%
      kable_styling(latex_options = c("hover", "striped", "HOLD_position"),
                    position = "center") %>% 
      column_spec(1, width = '1cm') %>%
      column_spec(2, width = '1cm') %>%
      column_spec(3, width = '3cm') %>%
      column_spec(4, width = '1cm') %>%
      column_spec(5, width = '3cm') %>%
      column_spec(6, width = '1cm') 

```


These assumptions result in the following distributions for queue time thorughout the day:

```{r arrivals, fig.cap='Simulated arrivals with a lunchtime and afterwork peak', fig.height=3, fig.width=6.5, fig.align='center'}
ggplot(data = arrivalsDF, aes(x = time, group = speed)) + 
        geom_histogram(color = 'black', fill = 'pink', binwidth = 60*60, boundary = 0) +
        scale_x_datetime(name = 'Time', breaks = 'hours', date_labels = '%H') +
        scale_y_continuous(name = 'Number of arrivals') + 
        theme_dark() +
        facet_wrap(~speed, ncol = 3)
```

# Queueing process

We assume that the process of being vaccinated is a linear four-stage process. The four stages are: 

1. Registration (patient registers at the facility and an initial temperature check is taken)
2. Assessment  (a more complete health history is taken)
3. Vaccination (the vaccine is administrated by an approved vaccinator)
4. Observation (the patient is monitored on site for any adverse effects)

```{r vac-process, fig.cap='The vaccination process', fig.height=1, fig.width=6.5, fig.align='center'}
## Nodes
nodes <- data.frame(id = 1:6, 
                    label = c('Entry', 'Registration', 'Assessment', 'Vaccination', 'Observation', 'Exit'),
                    group = c("Outside", "Admin", "Clinical", "Clinical", 'Admin', "Outside"),
                    level = c(1:6)) 
## Edges
edges <- data.frame(from = c(1, 2, 3, 4, 5), 
                    to = c(2, 3, 4, 5, 6))

## Visualise the network
visNetwork(nodes, edges, height = "500px", width = "100%") %>% 
  visGroups(groupname = "Admin", color = "orange", shape = "square") %>%
  visGroups(groupname = "Clinical", color = "blue", shape = "triangle") %>% 
  visGroups(groupname = "Outside", color = "lightgrey", shape = "rectangle") %>% 
  visEdges(arrows = "to") %>%
  visHierarchicalLayout(direction = "UD", levelSeparation = 100) %>%
  visLegend(position = "right")
```


# Assumptions re timing for each stage

The time taken for registration, assessment and vaccination are assumed to be exponentially distributed with rate parameters of 1/5, 1/10 and 1/2 respectively. The time spent in observation is assumed to be normally distributed with a mean of 15 and standard deviation of 2. 


```{r durations, fig.cap='Distribution of assumed durations for each stage', fig.subcap='Purple bars show the mean time for each stages', fig.height=5.5, fig.width=6.5, fig.align='center'}

durations <- data.frame(reg = regTime3, ass = assTime3, vac = vacTime3, obs = obsTime3) %>% 
              pivot_longer(cols = c(reg, ass, vac, obs), values_to = "time", names_to = "stage")

durations$stage <- factor(durations$stage, 
       levels = c('reg', 'ass', 'vac', 'obs'), 
       labels = c('Registration', 'Assessment', 'Vaccination', 'Observation'))

means <- durations %>% 
              group_by(stage) %>% 
              summarise(mean = mean(time)) 
  

ggplot(durations, aes(x = time, group = stage)) +
  geom_histogram(color = 'black', fill = 'pink', bins = 30) +
  geom_vline(aes(xintercept = mean), means, color = 'purple', size = 1.5) +
  facet_wrap(~ stage) + 
  labs(x = 'Duration (minutes)', y = 'Count') +
  theme_dark()

```


# Results

```{r, resultsDF}

# total length of all arrivals
simN <- length(arrivals1) + length(arrivals2) + length(arrivals3)

# compiule dataframe of results
resultsDF <- data.frame(
  scenario = c(rep('A', simN), rep('B', simN), rep('C', simN)),
  speed = rep(c(rep(1, length(arrivals1)), rep(2, length(arrivals2)), rep(3, length(arrivals3))), 3),
  duration = c(
      observationA1$departures - arrivals1,
      observationA2$departures - arrivals2,
      observationA3$departures - arrivals3,
      observationB1$departures - arrivals1,
      observationB2$departures - arrivals2,
      observationB3$departures - arrivals3,
      observationC1$departures - arrivals1,
      observationC2$departures - arrivals2,
      observationC3$departures - arrivals3
  )) %>% 
    group_by(scenario, speed) %>% 
    mutate(id = row_number())

# Apply factors
resultsDF$scenario <- factor(resultsDF$scenario, 
       levels = c('A', 'B', 'C'), 
       labels = c('Small GP', 'Larger GP', 'Vaccine hub'))
resultsDF$speed <- factor(resultsDF$speed, 
       levels = c('1', '2', '3'), 
       labels = c(paste0('Slow (', n1, ' patients)'),
                  paste0('Brisk (', n2, ' patients)'),
                  paste0('Heavy (', n3, ' patients)')
                  )
       )

```

## Overall time from arrival to exit

```{r busy, fig.cap='Distribution of waiting time by site capacity and rate of arrivals', fig.height=6.5, fig.width=6.5, fig.align='center'}

ggplot(resultsDF, aes(x = duration)) + 
  geom_histogram(color = 'black', fill = 'pink', bins = 12) +
  facet_wrap(scenario ~ speed, scales = 'free', strip.position = 'top') +
  theme_dark() +
  labs(y = 'Count', x = 'Duration (minutes)')

```


## Overall time by patient arrival ID

```{r duration, fig.cap='Total waiting times by patient ID, by site capacity and rate of arrivals', fig.height=6.5, fig.width=6.5, fig.align='center'}

ggplot(resultsDF, aes(x = id, y = duration)) + 
  geom_point(color = 'grey', size = .1) +
  geom_smooth(color = 'pink', method = 'gam') +
  facet_wrap(scenario ~ speed, scales = 'free', strip.position = 'top') +
  theme_dark() +
  labs(x = 'Patient index', y = 'Duration (minutes)')

```


```{r}

# Compile data frame of summary measures based on summary item from each simulation

summaryDF <- data.frame(
  node = rep(1:4, 9),
  scenario = c(rep('A', 12), rep('B', 12), rep('C', 12)),
  speed = rep(c(rep(1, 4), rep(2, 4), rep(3, 4)), 3)
) %>% 
  mutate(
    n = c( # Number of customers
      regSumA1$number_customers,
      assSumA1$number_customers,
      vacSumA1$number_customers,
      obsSumA1$number_customers,
      regSumA2$number_customers,
      assSumA2$number_customers,
      vacSumA2$number_customers,
      obsSumA2$number_customers,
      regSumA3$number_customers,
      assSumA3$number_customers,
      vacSumA3$number_customers,
      obsSumA3$number_customers,
      regSumB1$number_customers,
      assSumB1$number_customers,
      vacSumB1$number_customers,
      obsSumB1$number_customers,
      regSumB2$number_customers,
      assSumB2$number_customers,
      vacSumB2$number_customers,
      obsSumB2$number_customers,
      regSumB3$number_customers,
      assSumB3$number_customers,
      vacSumB3$number_customers,
      obsSumB3$number_customers,
      regSumC1$number_customers,
      assSumC1$number_customers,
      vacSumC1$number_customers,
      obsSumC1$number_customers,
      regSumC2$number_customers,
      assSumC2$number_customers,
      vacSumC2$number_customers,
      obsSumC2$number_customers,
      regSumC3$number_customers,
      assSumC3$number_customers,
      vacSumC3$number_customers,
      obsSumC3$number_customers
      ),
    
    busy = c( # Utilixation
      regSumA1$utilization,
      assSumA1$utilization,
      vacSumA1$utilization,
      obsSumA1$utilization,
      regSumA2$utilization,
      assSumA2$utilization,
      vacSumA2$utilization,
      obsSumA2$utilization,
      regSumA3$utilization,
      assSumA3$utilization,
      vacSumA3$utilization,
      obsSumA3$utilization,
      regSumB1$utilization,
      assSumB1$utilization,
      vacSumB1$utilization,
      obsSumB1$utilization,
      regSumB2$utilization,
      assSumB2$utilization,
      vacSumB2$utilization,
      obsSumB2$utilization,
      regSumB3$utilization,
      assSumB3$utilization,
      vacSumB3$utilization,
      obsSumB3$utilization,
      regSumC1$utilization,
      assSumC1$utilization,
      vacSumC1$utilization,
      obsSumC1$utilization,
      regSumC2$utilization,
      assSumC2$utilization,
      vacSumC2$utilization,
      obsSumC2$utilization,
      regSumC3$utilization,
      assSumC3$utilization,
      vacSumC3$utilization,
      obsSumC3$utilization
      ),
    
    mcis = c( # Mean customers in system
      regSumA1$slength_mean,
      assSumA1$slength_mean,
      vacSumA1$slength_mean,
      obsSumA1$slength_mean,
      regSumA2$slength_mean,
      assSumA2$slength_mean,
      vacSumA2$slength_mean,
      obsSumA2$slength_mean,
      regSumA3$slength_mean,
      assSumA3$slength_mean,
      vacSumA3$slength_mean,
      obsSumA3$slength_mean,
      regSumB1$slength_mean,
      assSumB1$slength_mean,
      vacSumB1$slength_mean,
      obsSumB1$slength_mean,
      regSumB2$slength_mean,
      assSumB2$slength_mean,
      vacSumB2$slength_mean,
      obsSumB2$slength_mean,
      regSumB3$slength_mean,
      assSumB3$slength_mean,
      vacSumB3$slength_mean,
      obsSumB3$slength_mean,
      regSumC1$slength_mean,
      assSumC1$slength_mean,
      vacSumC1$slength_mean,
      obsSumC1$slength_mean,
      regSumC2$slength_mean,
      assSumC2$slength_mean,
      vacSumC2$slength_mean,
      obsSumC2$slength_mean,
      regSumC3$slength_mean,
      assSumC3$slength_mean,
      vacSumC3$slength_mean,
      obsSumC3$slength_mean
      ),
    
    mwt = c( # Mean waiting time
      regSumA1$mwt,
      assSumA1$mwt,
      vacSumA1$mwt,
      obsSumA1$mwt,
      regSumA2$mwt,
      assSumA2$mwt,
      vacSumA2$mwt,
      obsSumA2$mwt,
      regSumA3$mwt,
      assSumA3$mwt,
      vacSumA3$mwt,
      obsSumA3$mwt,
      regSumB1$mwt,
      assSumB1$mwt,
      vacSumB1$mwt,
      obsSumB1$mwt,
      regSumB2$mwt,
      assSumB2$mwt,
      vacSumB2$mwt,
      obsSumB2$mwt,
      regSumB3$mwt,
      assSumB3$mwt,
      vacSumB3$mwt,
      obsSumB3$mwt,
      regSumC1$mwt,
      assSumC1$mwt,
      vacSumC1$mwt,
      obsSumC1$mwt,
      regSumC2$mwt,
      assSumC2$mwt,
      vacSumC2$mwt,
      obsSumC2$mwt,
      regSumC3$mwt,
      assSumC3$mwt,
      vacSumC3$mwt,
      obsSumC3$mwt
      ),
    
    mrt = c( # Mear response time
      regSumA1$mrt,
      assSumA1$mrt,
      vacSumA1$mrt,
      obsSumA1$mrt,
      regSumA2$mrt,
      assSumA2$mrt,
      vacSumA2$mrt,
      obsSumA2$mrt,
      regSumA3$mrt,
      assSumA3$mrt,
      vacSumA3$mrt,
      obsSumA3$mrt,
      regSumB1$mrt,
      assSumB1$mrt,
      vacSumB1$mrt,
      obsSumB1$mrt,
      regSumB2$mrt,
      assSumB2$mrt,
      vacSumB2$mrt,
      obsSumB2$mrt,
      regSumB3$mrt,
      assSumB3$mrt,
      vacSumB3$mrt,
      obsSumB3$mrt,
      regSumC1$mrt,
      assSumC1$mrt,
      vacSumC1$mrt,
      obsSumC1$mrt,
      regSumC2$mrt,
      assSumC2$mrt,
      vacSumC2$mrt,
      obsSumC2$mrt,
      regSumC3$mrt,
      assSumC3$mrt,
      vacSumC3$mrt,
      obsSumC3$mrt
      )
    
  )

# Apply factors
summaryDF$scenario <- factor(summaryDF$scenario, 
       levels = c('A', 'B', 'C'), 
       labels = c('Small GP', 'Larger GP', 'Vaccine hub'))
summaryDF$speed <- factor(summaryDF$speed, 
       levels = c('1', '2', '3'), 
       labels = c(paste0('Slow (', n1, ' patients)'),
                  paste0('Brisk (', n2, ' patients)'),
                  paste0('Heavy (', n3, ' patients)')
                  )
       )


```


## System utilisation

```{r utilisation, fig.cap='System utilisation at each queue node, by site capacity and rate of arrivals', fig.height=6.5, fig.width=6.5, fig.align='center'}

summaryDF %>% filter(node !=4) %>% 
  ggplot(aes(x = node, y = busy, fill = as.factor(node))) + 
  geom_bar(stat = 'identity') + 
  facet_wrap(scenario ~ speed) + 
  scale_y_continuous('Utilisation', labels = scales::percent_format()) +
  scale_x_discrete('Stage in queue', label = c('Registration', 'Assessment', 'Vaccination')) +
  scale_fill_manual('Stage', label = c('Registration', 'Assessment', 'Vaccination'), values = brewer.pal(11, 'PiYG')[c(4:2)]) +
  theme_dark() +
  theme(legend.position = 'bottom')

```

## Long-run average patients in the system

```{r capacity, fig.cap='Long-run average patients in the system at each queue node, by site capacity and rate of arrivals', fig.height=6.5, fig.width=6.5, fig.align='center'}

summaryDF %>% 
  ggplot(aes(x = node, y = mcis, fill = as.factor(node))) + 
  geom_bar(stat = 'identity') + 
  #geom_text(aes(label = round(mcis)), color = 'white', nudge_y = 1) +
  facet_wrap(scenario ~ speed) + 
  scale_y_continuous('Number in System') +
  scale_x_discrete('Stage in queue', label = c('Registration', 'Assessment', 'Vaccination', 'Observation')) +
  scale_fill_manual('Stage', label = c('Registration', 'Assessment', 'Vaccination', 'Observation'), values = brewer.pal(11, 'PiYG')[c(4:1)]) +
  theme_dark() +
  theme(legend.position = 'bottom')

```

## Waiting time

```{r waiting, fig.cap='Average waiting time at each node, by site capacity and rate of arrivals', fig.height=6.5, fig.width=6.5, fig.align='center'}

summaryDF %>% filter(node !=4) %>% 
  ggplot(aes(x = node, y = mwt, fill = as.factor(node))) + 
  geom_bar(stat = 'identity') + 
  #geom_text(aes(label = round(mwt, digits = 1)), color = 'white', nudge_y = 8) +
  facet_wrap(scenario ~ speed) + 
  scale_y_continuous('Waiting time (minutes)') +
  scale_x_discrete('Stage in queue', label = c('Registration', 'Assessment', 'Vaccination', 'Observation')) +
  scale_fill_manual('Stage', label = c('Registration', 'Assessment', 'Vaccination', 'Observation'), values = brewer.pal(11, 'PiYG')[c(4:1)]) +
  theme_dark() +
  theme(legend.position = 'bottom')

```

## Response time

```{r response, fig.cap='Average response time at each node, by site capacity and rate of arrivals', fig.height=6.5, fig.width=6.5, fig.align='center'}

summaryDF %>% filter(node !=4) %>% 
  ggplot(aes(x = node, y = mrt, fill = as.factor(node))) + 
  geom_bar(stat = 'identity') + 
  #geom_text(aes(label = round(mrt, digits = 1)), color = 'white', nudge_y = 8) +
  facet_wrap(scenario ~ speed) + 
  scale_y_continuous('Response time (minutes)') +
  scale_x_discrete('Stage in queue', label = c('Registration', 'Assessment', 'Vaccination', 'Observation')) +
  scale_fill_manual('Stage', label = c('Registration', 'Assessment', 'Vaccination', 'Observation'), values = brewer.pal(11, 'PiYG')[c(4:1)]) +
  theme_dark() +
  theme(legend.position = 'bottom')

```